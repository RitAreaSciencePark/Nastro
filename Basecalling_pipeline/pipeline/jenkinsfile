pipeline {
    agent { 
        node {
            label 'docker'
            }
    }
    environment {
        RUN_PARAMS_PATH = "None"
    }
    parameters {
        string(name: 'pathToSamplesheet', defaultValue: '/u/area/jenkins_onpexp/Pipeline_long_reads/samplesheet/orfeo_template.json', description: 'Path to the samplesheet of the work batch')
        string(name: 'pathToInputDir', defaultValue: '/u/area/jenkins_onpexp/scratch/TEST/input', description: 'Path to where the dir with symlinks will be stored. Root for each run input dir')
        string(name: 'pathToOutputDir', defaultValue: '/u/area/jenkins_onpexp/scratch/TEST/output', description: 'Path to where the output of the batch will be stored. Root for each run')
        string(name: 'pathToLogsDir', defaultValue: '/u/area/jenkins_onpexp/scratch/TEST/logs', description: 'Path to where the logs of the batch will be stored. Root for each run')
        string(name: 'basecallingModel', defaultValue: 'dna_r10.4.1_e8.2_400bps_hac.cfg', description: 'Basecalling model selected for this batch')
    }
    stages {
        stage('Pull project repository on the Cluster') {
            steps {
                withCredentials([sshUserPrivateKey(credentialsId: 'orfeo_jenkins_onpexp', keyFileVariable: 'SSH_ONPEXP_KEY', passphraseVariable: '', usernameVariable: 'SSH_ONPEXP_USER')]) {
                    sh '''
                        ssh -i ${SSH_ONPEXP_KEY} ${SSH_ONPEXP_USER}@10.128.2.80 '
                            cd /u/area/jenkins_onpexp/Pipeline_long_reads/Basecalling_pipeline && git pull
                        '
                    '''
                }    
            }
        }
        stage('TESTING CLEANUP') {
            steps {    
                withCredentials([sshUserPrivateKey(credentialsId: 'orfeo_jenkins_onpexp', keyFileVariable: 'SSH_ONPEXP_KEY', passphraseVariable: '', usernameVariable: 'SSH_ONPEXP_USER')]) {                                            
                    /*TO BE REMOVED*/
                    sh '''
                        ssh -i ${SSH_ONPEXP_KEY} ${SSH_ONPEXP_USER}@10.128.2.80 '
                            cd /u/area/jenkins_onpexp/Pipeline_long_reads/samplesheet/
                            cp orfeo_template_copy.json orfeo_template.json
                            cd /u/area/jenkins_onpexp/scratch/TEST
                            rm -rf input/*
                            rm -rf output/*
                            rm -rf logs/*
                        '
                    '''
                }
            }
        }        
        stage('Cleanup software dir') {
            steps {    
                withCredentials([sshUserPrivateKey(credentialsId: 'orfeo_jenkins_onpexp', keyFileVariable: 'SSH_ONPEXP_KEY', passphraseVariable: '', usernameVariable: 'SSH_ONPEXP_USER')]) {                                            
                    /*Check if all the trash is removed in the correct way*/
                    sh '''
                        ssh -i ${SSH_ONPEXP_KEY} ${SSH_ONPEXP_USER}@10.128.2.80 '
                            cd /u/area/jenkins_onpexp/Pipeline_long_reads/Basecalling_pipeline
                            rm -rf __pycache__
                        '
                    '''
                }
            }
        }
        stage('Read and check the samplesheet') {
            steps {    
                withCredentials([sshUserPrivateKey(credentialsId: 'orfeo_jenkins_onpexp', keyFileVariable: 'SSH_ONPEXP_KEY', passphraseVariable: '', usernameVariable: 'SSH_ONPEXP_USER')]) {                                            
                    /*Check if the samplesheet is correct*/
                    sh '''
                        ssh -i ${SSH_ONPEXP_KEY} ${SSH_ONPEXP_USER}@10.128.2.80 '
                            cd /u/area/jenkins_onpexp/Pipeline_long_reads/Basecalling_pipeline/samplesheet_check
                            python3 main.py '${pathToSamplesheet}'
                        '
                    '''
                }
            }
        }   
        stage('Subset the samplesheet and configure the run') {
            steps {    
                withCredentials([sshUserPrivateKey(credentialsId: 'orfeo_jenkins_onpexp', keyFileVariable: 'SSH_ONPEXP_KEY', passphraseVariable: '', usernameVariable: 'SSH_ONPEXP_USER')]) {                                            
                    /*Create from the batch samplesheet the subset to work on for this run
                    of the pipeline. This include input, output, log dirs and the config file*/
                    sh '''
                        ssh -i ${SSH_ONPEXP_KEY} ${SSH_ONPEXP_USER}@10.128.2.80 '
                            source ${HOME}/python_venvs/login_venv_jenkins/bin/activate
                            cd /u/area/jenkins_onpexp/Pipeline_long_reads/Basecalling_pipeline/subset_creation

                            python3 main.py '${pathToSamplesheet}' '${pathToInputDir}' '${pathToOutputDir}' '${pathToLogsDir}' '${basecallingModel}'
                            echo "${RUN_PARAMS_PATH}"

                            deactivate
                        ' 
                    '''
                }
            }
        }     
        stage('Create sbatch script and launch the basecalling') {
            steps {    
                withCredentials([sshUserPrivateKey(credentialsId: 'orfeo_jenkins_onpexp', keyFileVariable: 'SSH_ONPEXP_KEY', passphraseVariable: '', usernameVariable: 'SSH_ONPEXP_USER')]) {                                            
                    /*Use the run config to create a sbatch script and launch it*/
                    sh '''
                        ssh -i ${SSH_ONPEXP_KEY} ${SSH_ONPEXP_USER}@10.128.2.80 '
                            cd /u/area/jenkins_onpexp/Pipeline_long_reads/Basecalling_pipeline/launch_run
                            python3 main.py '${RUN_PARAMS_PATH}'
                        '
                    '''
                }
            }
        }                   
    }
}
